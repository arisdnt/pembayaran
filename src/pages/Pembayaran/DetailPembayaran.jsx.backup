import { useEffect, useState } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { PageLayout } from '../../layout/PageLayout'
import { Text, Badge, Button } from '@radix-ui/themes'
import { ArrowLeft, Printer, X } from 'lucide-react'
import { db } from '../../offline/db'
import { SCHOOL_IDENTITY } from '../../config/appInfo'

function formatCurrency(amount) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0,
  }).format(amount || 0)
}

function formatDate(dateStr) {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleDateString('id-ID', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
  })
}

function terbilang(angka) {
  const bilangan = [
    '', 'satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'delapan', 'sembilan',
    'sepuluh', 'sebelas'
  ]

  if (angka < 12) return bilangan[angka]
  if (angka < 20) return bilangan[angka - 10] + ' belas'
  if (angka < 100) return bilangan[Math.floor(angka / 10)] + ' puluh ' + bilangan[angka % 10]
  if (angka < 200) return 'seratus ' + terbilang(angka - 100)
  if (angka < 1000) return bilangan[Math.floor(angka / 100)] + ' ratus ' + terbilang(angka % 100)
  if (angka < 2000) return 'seribu ' + terbilang(angka - 1000)
  if (angka < 1000000) return terbilang(Math.floor(angka / 1000)) + ' ribu ' + terbilang(angka % 1000)
  if (angka < 1000000000) return terbilang(Math.floor(angka / 1000000)) + ' juta ' + terbilang(angka % 1000000)
  if (angka < 1000000000000) return terbilang(Math.floor(angka / 1000000000)) + ' miliar ' + terbilang(angka % 1000000000)
  if (angka < 1000000000000000) return terbilang(Math.floor(angka / 1000000000000)) + ' triliun ' + terbilang(angka % 1000000000000)
  return angka.toString()
}

function angkaTerbilang(angka) {
  if (!angka || angka === 0) return 'nol rupiah'
  const hasil = terbilang(Math.floor(angka)).trim()
  return hasil.charAt(0).toUpperCase() + hasil.slice(1) + ' rupiah'
}

function getMetodeLabel(metode) {
  const labels = {
    cash: 'Tunai',
    transfer: 'Transfer',
    qris: 'QRIS',
    'e-wallet': 'E-Wallet',
    kartu_debit: 'Debit',
    kartu_kredit: 'Kredit',
  }
  return labels[metode] || metode
}

function DetailPembayaranContent() {
  const navigate = useNavigate()
  const { id } = useParams()
  const [loading, setLoading] = useState(true)
  const [pembayaran, setPembayaran] = useState(null)
  const [error, setError] = useState('')

  useEffect(() => {
    const fetchPembayaran = async () => {
      try {
        setLoading(true)

        const pembayaranRow = await db.pembayaran.get(id)
        if (!pembayaranRow) throw new Error('Pembayaran tidak ditemukan')
        const tagihan = await db.tagihan.get(pembayaranRow.id_tagihan)
        const rks = tagihan ? await db.riwayat_kelas_siswa.get(tagihan.id_riwayat_kelas_siswa) : null
        const siswa = rks ? await db.siswa.get(rks.id_siswa) : null
        const kelas = rks ? await db.kelas.get(rks.id_kelas) : null
        const tahun = rks ? await db.tahun_ajaran.get(rks.id_tahun_ajaran) : null
        const rincianAll = await db.rincian_pembayaran.where('id_pembayaran').equals(id).toArray()
        const rincianPembayaran = rincianAll.sort((a, b) => (a.cicilan_ke || 0) - (b.cicilan_ke || 0))
        const rincianTagihan = tagihan ? await db.rincian_tagihan.where('id_tagihan').equals(tagihan.id).toArray() : []

        setPembayaran({
          ...pembayaranRow,
          tagihan: tagihan && {
            ...tagihan,
            riwayat_kelas_siswa: rks && {
              siswa: siswa && { nama_lengkap: siswa.nama_lengkap, nisn: siswa.nisn },
              kelas: kelas && { tingkat: kelas.tingkat, nama_sub_kelas: kelas.nama_sub_kelas },
              tahun_ajaran: tahun && { nama: tahun.nama },
            },
            rincian_tagihan: rincianTagihan,
          },
          rincian_pembayaran: rincianPembayaran,
        })
      } catch (err) {
        console.error('Error fetching pembayaran:', err)
        setError(err.message)
      } finally {
        setLoading(false)
      }
    }

    if (id) {
      fetchPembayaran()
    }
  }, [id])

  if (loading) {
    return (
      <PageLayout>
        <div className="flex items-center justify-center h-full">
          <Text size="3" className="text-slate-500">Memuat data pembayaran...</Text>
        </div>
      </PageLayout>
    )
  }

  if (error || !pembayaran) {
    return (
      <PageLayout>
        <div className="flex flex-col items-center justify-center h-full gap-4">
          <Text size="4" className="text-red-600">Gagal memuat data pembayaran</Text>
          {error && <Text size="2" className="text-slate-500">{error}</Text>}
          <button
            onClick={() => navigate('/pembayaran')}
            className="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 transition-colors"
          >
            Kembali ke Daftar Pembayaran
          </button>
        </div>
      </PageLayout>
    )
  }

  const totalTagihan = pembayaran.tagihan?.rincian_tagihan?.reduce((sum, r) => sum + parseFloat(r.jumlah || 0), 0) || 0
  const totalPembayaran = pembayaran.rincian_pembayaran?.reduce((sum, r) => sum + parseFloat(r.jumlah_dibayar || 0), 0) || 0

  return (
    <PageLayout>
      <div className="flex flex-col h-full bg-white">
        {/* Header dengan tombol aksi */}
        <div className="shrink-0 px-6 py-4">
          <div className="flex items-center justify-end gap-3">
            <Button
              onClick={() => window.print()}
              className="cursor-pointer text-white font-medium shadow-sm hover:shadow transition-all"
              style={{ borderRadius: 0 }}
              size="2"
            >
              <FileText className="h-4 w-4" />
              Cetak Invoice
            </Button>
            <Button
              onClick={() => navigate('/pembayaran')}
              variant="soft"
              color="gray"
              size="2"
              style={{ borderRadius: 0 }}
              className="cursor-pointer hover:bg-slate-200 transition-colors"
            >
              <ArrowLeft className="h-4 w-4" />
              Kembali
            </Button>
          </div>
        </div>

        {/* Invoice Container */}
        <div className="flex-1 overflow-auto px-5 py-6">
          <div className="w-full flex justify-center">
            {/* Paper-like Invoice - A4 Size */}
            <div
              className="bg-white shadow-xl border border-slate-200 print:shadow-none print:border-0 w-full max-w-[210mm]"
              style={{ minHeight: 'auto' }}
            >

              {/* Invoice Header */}
              <div className="px-8 pt-6 pb-4">
                <div className="flex items-start justify-between mb-4 gap-6">
                  <div>
                    <Text size="4" weight="bold" className="text-slate-900 block mb-1">
                      {schoolName}
                    </Text>
                    {schoolAddress && (
                      <Text size="1" className="text-slate-600 block mb-1 max-w-xs leading-relaxed">
                        {schoolAddress}
                      </Text>
                    )}
                    {schoolPhone && (
                      <Text size="1" className="text-slate-600 block">
                        Telp: {schoolPhone}
                      </Text>
                    )}
                    {schoolEmail && (
                      <Text size="1" className="text-slate-600 block">
                        Email: {schoolEmail}
                      </Text>
                    )}
                    {schoolWebsite && (
                      <Text size="1" className="text-slate-600 block">
                        Website: {schoolWebsite}
                      </Text>
                    )}
                  </div>
                  <div className="text-right">
                    <Text size="1" className="text-slate-500 uppercase tracking-wider block mb-1">
                      Invoice Number
                    </Text>
                    <Text size="3" weight="bold" className="text-slate-900 font-mono block pb-1 border-b border-slate-300">
                      {pembayaran.nomor_pembayaran}
                    </Text>
                    <Text size="1" className="text-slate-500 mt-2 block">
                      {formatDateTime(pembayaran.diperbarui_pada)}
                    </Text>
                  </div>
                </div>

                {/* Bill To Section */}
                {pembayaran.tagihan?.riwayat_kelas_siswa && (
                  <div className="grid grid-cols-2 gap-6">
                    <div>
                      <Text size="1" className="text-slate-500 uppercase tracking-wider mb-2 block font-semibold">
                        Tagihan Untuk
                      </Text>
                      <div className="space-y-0.5">
                        <Text size="2" weight="bold" className="text-slate-900 block">
                          {pembayaran.tagihan.riwayat_kelas_siswa.siswa?.nama_lengkap}
                        </Text>
                        <Text size="1" className="text-slate-600 block font-mono">
                          NISN: {pembayaran.tagihan.riwayat_kelas_siswa.siswa?.nisn}
                        </Text>
                        <Text size="1" className="text-slate-600 block">
                          Kelas {pembayaran.tagihan.riwayat_kelas_siswa.kelas?.tingkat} {pembayaran.tagihan.riwayat_kelas_siswa.kelas?.nama_sub_kelas}
                        </Text>
                        <Text size="1" className="text-slate-600 block">
                          {pembayaran.tagihan.riwayat_kelas_siswa.tahun_ajaran?.nama}
                        </Text>
                      </div>
                    </div>
                    <div>
                      <Text size="1" className="text-slate-500 uppercase tracking-wider mb-2 block font-semibold">
                        Detail Tagihan
                      </Text>
                      <div className="space-y-0.5">
                        <Text size="1" className="text-slate-600 block">
                          <span className="text-slate-500">No. Tagihan:</span>{' '}
                          <span className="font-mono font-semibold">{pembayaran.tagihan.nomor_tagihan}</span>
                        </Text>
                        <Text size="1" className="text-slate-600 block">
                          <span className="text-slate-500">Keterangan:</span>{' '}
                          <span className="font-medium">{pembayaran.tagihan.judul}</span>
                        </Text>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Invoice Items Table */}
              <div className="px-8 py-6">
                <Text size="2" weight="bold" className="text-slate-900 uppercase tracking-wider mb-3 block">
                  Rincian Transaksi Pembayaran
                </Text>

                <table className="w-full">
                  <thead>
                    <tr className="border-b-2 border-slate-900">
                      <th className="text-left py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          No
                        </Text>
                      </th>
                      <th className="text-left py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          Nomor Transaksi
                        </Text>
                      </th>
                      <th className="text-left py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          Cicilan
                        </Text>
                      </th>
                      <th className="text-left py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          Tanggal
                        </Text>
                      </th>
                      <th className="text-left py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          Metode
                        </Text>
                      </th>
                      <th className="text-right py-3 px-2">
                        <Text size="1" weight="bold" className="text-slate-700 uppercase tracking-wider">
                          Jumlah
                        </Text>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {pembayaran.rincian_pembayaran && pembayaran.rincian_pembayaran.length > 0 ? (
                      pembayaran.rincian_pembayaran.map((rincian, index) => (
                        <tr key={rincian.id} className="border-b border-slate-200 hover:bg-slate-50">
                          <td className="py-4 px-2">
                            <Text size="2" className="text-slate-700">
                              {index + 1}
                            </Text>
                          </td>
                          <td className="py-4 px-2">
                            <Text size="2" className="text-slate-900 font-mono">
                              {rincian.nomor_transaksi}
                            </Text>
                            {rincian.referensi_pembayaran && (
                              <Text size="1" className="text-slate-500 font-mono block mt-1">
                                Ref: {rincian.referensi_pembayaran}
                              </Text>
                            )}
                          </td>
                          <td className="py-4 px-2">
                            <Text size="2" className="text-slate-700">
                              Ke-{rincian.cicilan_ke}
                            </Text>
                          </td>
                          <td className="py-4 px-2">
                            <Text size="2" className="text-slate-700">
                              {formatDateTime(rincian.tanggal_bayar)}
                            </Text>
                          </td>
                          <td className="py-4 px-2">
                            <Text size="2" className="text-slate-700 capitalize">
                              {rincian.metode_pembayaran}
                            </Text>
                          </td>
                          <td className="py-4 px-2 text-right">
                            <Text size="2" weight="bold" className="text-slate-900 font-mono">
                              {formatCurrency(rincian.jumlah_dibayar)}
                            </Text>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="7" className="py-8 text-center">
                          <Text size="2" className="text-slate-500">
                            Tidak ada rincian transaksi
                          </Text>
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              {/* Invoice Summary */}
              <div className="px-8 pb-6">
                <div className="flex justify-end">
                  <div className="w-72 space-y-1">
                    <div className="flex justify-between items-center pb-1">
                      <Text size="2" className="text-slate-600">
                        Total Tagihan:
                      </Text>
                      <Text size="3" className="text-slate-900 font-mono">
                        {formatCurrency(totalTagihan)}
                      </Text>
                    </div>

                    <div className="flex justify-between items-center pb-1 border-t border-slate-200 pt-1">
                      <Text size="2" className="text-green-700">
                        Total Pembayaran:
                      </Text>
                      <Text size="3" weight="medium" className="text-green-700 font-mono">
                        {formatCurrency(totalPembayaran)}
                      </Text>
                    </div>

                    <div className="flex justify-between items-center py-3 border-t-2 border-slate-900">
                      <Text size="3" weight="bold" className="text-slate-900 uppercase">
                        Sisa Tagihan:
                      </Text>
                      <Text size="5" weight="bold" className="text-slate-900 font-mono">
                        {formatCurrency(Math.max(0, totalTagihan - totalPembayaran))}
                      </Text>
                    </div>
                  </div>
                </div>
              </div>

              {/* Notes & Footer */}
              {pembayaran.catatan && (
                <div className="px-8 pb-6 border-t border-slate-200 pt-6">
                  <Text size="1" className="text-slate-500 uppercase tracking-wider mb-2 block font-semibold">
                    Catatan Pembayaran
                  </Text>
                  <Text size="2" className="text-slate-700 leading-relaxed">
                    {pembayaran.catatan}
                  </Text>
                </div>
              )}

              {/* Invoice Footer */}
              <div className="px-8 py-5 bg-white border-t border-slate-200">
                <div className="grid grid-cols-3 gap-6 mb-4">
                  <div className="text-center">
                    <Text size="1" className="text-slate-500 uppercase tracking-wider mb-8 block">
                      Diserahkan Oleh
                    </Text>
                    <div className="border-t border-slate-900 pt-2 mt-6">
                      <Text size="2" className="text-slate-700">
                        (..................................)
                      </Text>
                    </div>
                  </div>
                  <div className="text-center">
                    <Text size="1" className="text-slate-500 uppercase tracking-wider mb-8 block">
                      Diterima Oleh
                    </Text>
                    <div className="border-t border-slate-900 pt-2 mt-6">
                      <Text size="2" className="text-slate-700">
                        (..................................)
                      </Text>
                    </div>
                  </div>
                  <div className="text-center">
                    <Text size="1" className="text-slate-500 uppercase tracking-wider mb-8 block">
                      Mengetahui
                    </Text>
                    <div className="border-t border-slate-900 pt-2 mt-6">
                      <Text size="2" className="text-slate-700">
                        (..................................)
                      </Text>
                    </div>
                  </div>
                </div>

                <div className="text-center border-t border-slate-200 pt-3">
                  <Text size="1" className="text-slate-500">
                    Invoice ID: {pembayaran.id}
                  </Text>
                  <Text size="1" className="text-slate-400 block mt-1">
                    Dokumen ini dicetak secara otomatis dan sah tanpa tanda tangan basah
                  </Text>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      {/* Print Styles */}
      <style>{`
        @page {
          size: A4 portrait;
          margin: 15mm;
        }
        @media print {
          body * {
            visibility: hidden;
          }
          .print\\:shadow-none,
          .print\\:shadow-none * {
            visibility: visible;
          }
          .print\\:shadow-none {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
          }
          button {
            display: none !important;
          }
        }
      `}</style>
    </PageLayout>
  )
}

export function DetailPembayaran() {
  return <DetailPembayaranContent />
}
